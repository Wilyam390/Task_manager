# Azure DevOps Pipeline for Task Manager
# Automated CI/CD for building, testing, and deploying to Azure App Service
#
# Setup Instructions:
# 1. Create service connection in Azure DevOps (Project Settings > Service Connections)
# 2. Update variables below with your Azure resource names
# 3. Save this file and push to trigger the pipeline

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/*
      - '*.md'

# Run on Pull Requests
pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  pythonVersion: '3.11'
  azureSubscription: 'YourAzureServiceConnection'  # TODO: Update with your service connection name
  webAppName: 'taskmanager-app'  # TODO: Update with your App Service name
  resourceGroup: 'taskmanager-rg'  # TODO: Update with your resource group name
  buildConfiguration: 'Release'

stages:
  # ============================================================================
  # BUILD STAGE - Install dependencies, run tests, create artifacts
  # ============================================================================
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildJob
        displayName: 'Build Application'
        steps:
          # Use specified Python version
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
            displayName: 'Use Python $(pythonVersion)'

          # Display Python version for debugging
          - script: |
              python --version
              pip --version
            displayName: 'Display Python version'

          # Install dependencies
          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          # Initialize test database
          - script: |
              python init_db.py
            displayName: 'Initialize test database'

          # Run linting (optional but recommended)
          - script: |
              pip install pylint
              pylint app.py --disable=C,R,W || true
            displayName: 'Run code linting (non-blocking)'
            continueOnError: true

          # Run unit tests with coverage
          - script: |
              pip install pytest pytest-cov
              pytest tests/ --junitxml=junit/test-results.xml --cov=. --cov-report=xml --cov-report=html --cov-report=term-missing
            displayName: 'Run tests with coverage'

          # Publish test results
          - task: PublishTestResults@2
            condition: succeededOrFailed()
            inputs:
              testResultsFiles: '**/test-*.xml'
              testRunTitle: 'Python $(pythonVersion) Tests'
              failTaskOnFailedTests: true
            displayName: 'Publish test results'

          # Publish code coverage
          - task: PublishCodeCoverageResults@1
            inputs:
              codeCoverageTool: Cobertura
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.xml'
              reportDirectory: '$(System.DefaultWorkingDirectory)/**/htmlcov'
            displayName: 'Publish coverage results'

          # Create deployment package
          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
              replaceExistingArchive: true
              verbose: true
            displayName: 'Create deployment package'

          # Publish build artifacts
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'drop'
              publishLocation: 'Container'
            displayName: 'Publish build artifacts'

  # ============================================================================
  # DEPLOY STAGE - Deploy to Azure App Service (Production)
  # ============================================================================
  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployWeb
        displayName: 'Deploy to Azure App Service'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                # Download build artifacts
                - task: DownloadBuildArtifacts@0
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'drop'
                    downloadPath: '$(System.ArtifactsDirectory)'
                  displayName: 'Download build artifacts'

                # Deploy to Azure Web App
                - task: AzureWebApp@1
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'webAppLinux'
                    appName: '$(webAppName)'
                    package: '$(System.ArtifactsDirectory)/drop/$(Build.BuildId).zip'
                    runtimeStack: 'PYTHON|3.11'
                    startUpCommand: 'gunicorn --bind=0.0.0.0 --timeout 600 app:app'
                  displayName: 'Deploy to Azure App Service'

                # Configure App Service settings
                - task: AzureAppServiceSettings@1
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appName: '$(webAppName)'
                    resourceGroupName: '$(resourceGroup)'
                    appSettings: |
                      [
                        {
                          "name": "ENVIRONMENT",
                          "value": "production",
                          "slotSetting": false
                        },
                        {
                          "name": "DB_TYPE",
                          "value": "azure_sql",
                          "slotSetting": false
                        },
                        {
                          "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
                          "value": "true",
                          "slotSetting": false
                        },
                        {
                          "name": "WEBSITE_HTTPLOGGING_RETENTION_DAYS",
                          "value": "7",
                          "slotSetting": false
                        }
                      ]
                  displayName: 'Configure App Service settings'

                # Run smoke tests
                - task: PowerShell@2
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host "Running smoke tests..."
                      $response = Invoke-WebRequest -Uri "https://$(webAppName).azurewebsites.net/health" -UseBasicParsing
                      Write-Host "Health check status: $($response.StatusCode)"
                      if ($response.StatusCode -ne 200) {
                        Write-Error "Health check failed!"
                        exit 1
                      }
                      Write-Host "Deployment verified successfully!"
                  displayName: 'Run smoke tests'
                  continueOnError: false

  # ============================================================================
  # DEPLOY STAGE - Deploy to Staging (for develop branch)
  # ============================================================================
  - stage: DeployStaging
    displayName: 'Deploy to Staging'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    jobs:
      - deployment: DeployStaging
        displayName: 'Deploy to Staging Environment'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'drop'
                    downloadPath: '$(System.ArtifactsDirectory)'

                - script: echo "Deploy to staging slot would go here"
                  displayName: 'Staging deployment placeholder'
